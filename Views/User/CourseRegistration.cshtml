@model TGTOAT.Models.CourseRegisterViewModel

@{
    ViewData["Title"] = "CourseRegistration";
    Layout = "~/Views/Shared/_StudentLayout.cshtml";
}

<h1>Course Registration</h1>

@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger">
        @ViewBag.ErrorMessage
    </div>
}

@if (ViewBag.SuccessMessage != null)
{
    <div class="alert alert-success">
        @ViewBag.SuccessMessage
    </div>
}


<form method="get" asp-action="FilterCourses">
    <div class="row mb-3">
      <div class="col">
          <div class="form-group">
            <label for="departmentSelect">Select Department:</label>
            <select asp-for="DepartmentId" class="form-control" id="departmentSelect" asp-items="@(new SelectList(Model.Departments, "DepartmentId", "DepartmentName"))" required>
            <option value="">Select a department</option>
          </select>
         </div>
        </div>
        <div class="col">
         <div class="form-group">
           <label for="searchTerm">Search For Courses:</label>
            <div class="input-group">
               <input type="text" class="form-control" id="searchTerm" placeholder="Search for courses..." name="searchTerm" />
                <div class="input-group-append">
                     <button class="btn btn-primary" type="submit">Search</button>
                </div>
             </div>
          </div>
      </div>
  </div>
</form>


<table class="table">
    <thead>
        <tr>
            <th>Course Number</th>
            <th>Course Name</th>
            <th>Credits</th>
            <th>Instructor</th>
            <th>Days</th>
            <th>Time</th>
            <th>Location</th>
            <th>Selection</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var course in Model.Courses) // Corrected line
        {
            <tr>
                <td>@course.CourseNumber</td>
                <td>@course.CourseName</td>
                <td>@course.NumberOfCredits</td>
       
                <td>
                        @if (Model.Instructors != null && Model.Instructors.Any())
                        {
                            // Get the CourseId for the current course
                            var courseId = course.CourseId;

                            // Filter instructors based on UserCourseConnections
                            var courseInstructors = Model.InstructorCourseConnections
                            .Where(uc => uc.CourseId == courseId)
                            .Select(uc => Model.Instructors.FirstOrDefault(i => i.Id == uc.InstructorID))
                            .Where(i => i != null) // Ensure that we only include valid instructors
                            .ToList();

                            if (courseInstructors.Any())
                            {
                            <ul>
                                    @foreach (var instructor in courseInstructors)
                                    {
                                        @instructor.FirstName @instructor.LastName
                                    }
                            </ul>
                            }
                            else
                            {
                            <span>No instructors assigned</span>
                            }
                        }
                        else
                        {
                        <span>No instructors assigned</span>
                        }
                </td>
           
                <td>@course.DaysOfTheWeek</td>
                <td>
                    @(course.StartTime?.ToString("hh:mm tt") ?? "N/A") - @(course.EndTime?.ToString("hh:mm tt") ?? "N/A")
                </td>
                <td>@course.RoomNumber</td>
                <td>
                    <div class="row">
                        <div class="col-auto">
                    <form method="post" asp-action="Register">
                        <input type="hidden" name="CourseId" value="@course.CourseId" />
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                        </div>
                            <div class="col-auto">
                    <form method="post" asp-action="Drop">
                        <input type="hidden" name="CourseId" value="@course.CourseId" />
                        <button type="submit" class="btn btn-danger">Drop</button>
                    </form>
                        </div>
                    </div>
                </td>
               
            </tr>
        }
    </tbody>
</table>
